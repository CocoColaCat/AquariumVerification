<!doctype html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ°´æ—é¤¨é©—è­‰å¾Œè‡ºç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans TC', sans-serif; }
    .table-row:hover { background-color: rgba(6, 182, 212, 0.08); }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn-hover { transition: all 0.2s ease; }
    .btn-hover:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  </style>
</head>
<body class="h-full bg-slate-900 text-slate-100">
  <div id="app-container" class="h-full w-full overflow-auto">
    <!-- Login Screen -->
    <div id="login-screen" class="h-full w-full flex items-center justify-center bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
      <div class="bg-slate-800 border border-slate-700 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="flex justify-center mb-6">
          <div class="w-16 h-16 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" />
            </svg>
          </div>
        </div>
        <h1 class="text-2xl font-bold text-center text-white mb-2">æ°´æ—é¤¨é©—è­‰å¾Œè‡ºç®¡ç†ç³»çµ±</h1>
        <p class="text-center text-slate-400 mb-8">è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼</p>
        <div class="mb-6">
          <input id="login-password" type="password" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
        </div>
        <button id="login-btn" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold py-3 rounded-lg btn-hover transition">
          é€²å…¥ç³»çµ±
        </button>
        <div id="login-error" class="mt-4 text-red-400 text-sm text-center hidden"></div>
      </div>
    </div>

    <!-- Main System -->
    <div id="main-system" class="hidden">
      <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" />
                </svg>
              </div>
              <h1 class="text-xl font-bold text-white">æ°´æ—é¤¨é©—è­‰å¾Œè‡ºç®¡ç†ç³»çµ±</h1>
            </div>
            <button id="logout-btn" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
              ç™»å‡º
            </button>
          </div>
        </div>
      </header>

      <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-750">
                <tr class="border-b border-slate-700">
                  <th class="text-left px-6 py-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">ä½¿ç”¨è€…åç¨±</th>
                  <th class="text-left px-6 py-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">é©—è­‰æ™‚é–“</th>
                  <th class="text-left px-6 py-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">ç”¨æˆ¶ ID</th>
                  <th class="text-left px-6 py-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">IP</th>
                  <th class="text-left px-6 py-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">ç‹€æ…‹</th>
                  <th class="text-center px-6 py-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
          <div id="empty-state" class="py-16 text-center hidden">
            <p class="text-slate-400 text-lg">å°šç„¡é©—è­‰è³‡æ–™</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- æ“ä½œ Modal -->
  <div id="operations-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
      <h3 class="text-lg font-semibold text-white mb-1" id="modal-username"></h3>
      <p class="text-slate-400 text-sm mb-6" id="modal-userid"></p>
      <div class="space-y-3">
        <button class="operation-btn w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-3 rounded-lg font-medium transition" data-op="suspend">ğŸš« åœæ¬Šå¸³è™Ÿ</button>
        <button class="operation-btn w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded-lg font-medium transition" data-op="kick">ğŸ‘¢ è¸¢å‡ºç©å®¶</button>
        <button class="operation-btn w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-medium transition" data-op="delete-verify">ğŸ—‘ï¸ åˆªé™¤é©—è­‰è¨˜éŒ„</button>
        <button id="modal-cancel" class="w-full bg-slate-600 hover:bg-slate-500 text-white px-4 py-3 rounded-lg font-medium transition">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- å¯†ç¢¼ç¢ºèª Modal -->
  <div id="password-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-slate-800 rounded-xl p-6 max-w-md w-full mx-4 border border-slate-700">
      <h3 class="text-lg font-semibold text-white mb-2">é©—è­‰èº«ä»½</h3>
      <p class="text-slate-400 mb-6" id="password-modal-action"></p>
      <div class="mb-4">
        <input id="password-confirm" type="password" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
      </div>
      <div class="flex gap-3">
        <button id="password-cancel" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white px-4 py-3 rounded-lg font-medium transition">å–æ¶ˆ</button>
        <button id="password-confirm-btn" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-3 rounded-lg font-medium transition">ç¢ºèª</button>
      </div>
      <div id="password-error" class="mt-3 text-red-400 text-sm text-center hidden"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="action-toast" class="hidden fixed bottom-6 right-6 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg">
    <span id="toast-message"></span>
  </div>

  <script>
    const socket = io('https://aquariumverification-backed.onrender.com'); // é€£åˆ°å¾Œç«¯ï¼ˆåŒæºï¼‰ï¼Œä¸åŒæºè«‹æ”¹æˆ io('https://ä½ çš„renderç¶²å€')

    let currentTarget = null;
    let pendingOperation = null;

    // æ ¼å¼åŒ–æ™‚é–“
    function formatDate(iso) {
      if (!iso) return '-';
      return new Date(iso).toLocaleString('zh-TW', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    // ç‹€æ…‹é¡è‰²
    function getStatusColor(status) {
      switch(status) {
        case 'æ­£å¸¸': return 'bg-emerald-900 text-emerald-300';
        case 'å·²åœæ¬Š': return 'bg-red-900 text-red-300';
        case 'å·²è¸¢å‡º': return 'bg-orange-900 text-orange-300';
        default: return 'bg-slate-700 text-slate-300';
      }
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(accounts) {
      const tbody = document.getElementById('table-body');
      const empty = document.getElementById('empty-state');
      tbody.innerHTML = '';
      if (accounts.length === 0) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      accounts.forEach(acc => {
        const row = document.createElement('tr');
        row.className = 'table-row border-b border-slate-700/50 fade-in';
        row.innerHTML = `
          <td class="px-6 py-4 font-medium text-white">${acc.username || '-'}</td>
          <td class="px-6 py-4 text-slate-300">${formatDate(acc.verifiedAt)}</td>
          <td class="px-6 py-4"><code class="bg-slate-700 px-2 py-1 rounded text-cyan-400 text-sm">${acc.userId || '-'}</code></td>
          <td class="px-6 py-4"><code class="bg-slate-700 px-2 py-1 rounded text-emerald-400 text-sm">${acc.ip || '-'}</code></td>
          <td class="px-6 py-4">
            <span class="px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(acc.status)}">
              ${acc.status || 'æ­£å¸¸'}
            </span>
          </td>
          <td class="px-6 py-4 text-center">
            <button class="action-menu-btn bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition" 
                    data-id="${acc.id}" data-userid="${acc.userId}" data-username="${acc.username}">
              âš™ï¸ æ“ä½œ
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // é¡¯ç¤º Toast
    function showToast(msg) {
      const toast = document.getElementById('action-toast');
      document.getElementById('toast-message').textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // é¡¯ç¤ºå¯†ç¢¼ç¢ºèª Modal
    function showPasswordModal(op, username) {
      pendingOperation = op;
      document.getElementById('password-modal-action').textContent = `ç¢ºèªå° ${username} é€²è¡Œ ${op === 'suspend' ? 'åœæ¬Š' : op === 'kick' ? 'è¸¢å‡º' : 'åˆªé™¤é©—è­‰è¨˜éŒ„'}ï¼Ÿ`;
      document.getElementById('password-confirm').value = '';
      document.getElementById('password-error').classList.add('hidden');
      document.getElementById('password-modal').classList.remove('hidden');
    }

    // ç™»å…¥
    document.getElementById('login-btn').addEventListener('click', async () => {
      const pwd = document.getElementById('login-password').value;
      const error = document.getElementById('login-error');

      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd })
        });
        const data = await res.json();

        if (data.success) {
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('main-system').classList.remove('hidden');
          loadAccounts();
        } else {
          error.textContent = data.message || 'å¯†ç¢¼éŒ¯èª¤';
          error.classList.remove('hidden');
        }
      } catch (err) {
        error.textContent = 'é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
        error.classList.remove('hidden');
      }
    });

    // è¼‰å…¥å¸³è™Ÿåˆ—è¡¨
    async function loadAccounts() {
      try {
        const res = await fetch('/accounts');
        const accounts = await res.json();
        renderTable(accounts);
      } catch (err) {
        console.error('è¼‰å…¥å¸³è™Ÿå¤±æ•—:', err);
      }
    }

    // ç™»å‡º
    document.getElementById('logout-btn').addEventListener('click', () => {
      document.getElementById('main-system').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-password').value = '';
      document.getElementById('login-error').classList.add('hidden');
    });

    // æ“ä½œæŒ‰éˆ•
    document.getElementById('table-body').addEventListener('click', (e) => {
      const btn = e.target.closest('.action-menu-btn');
      if (btn) {
        const id = btn.dataset.id;
        const userid = btn.dataset.userid;
        const username = btn.dataset.username;
        document.getElementById('modal-username').textContent = username;
        document.getElementById('modal-userid').textContent = `ID: ${userid}`;
        document.getElementById('operations-modal').classList.remove('hidden');
        currentTarget = { id, userid, username };
      }
    });

    // æ“ä½œé¸æ“‡
    document.querySelectorAll('.operation-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (!currentTarget) return;
        showPasswordModal(btn.dataset.op, currentTarget.username);
      });
    });

    // å–æ¶ˆ Modal
    document.getElementById('modal-cancel').addEventListener('click', () => {
      document.getElementById('operations-modal').classList.add('hidden');
    });

    // å¯†ç¢¼ç¢ºèª
    document.getElementById('password-confirm-btn').addEventListener('click', async () => {
      const pwd = document.getElementById('password-confirm').value;
      const error = document.getElementById('password-error');

      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd })
        });
        const data = await res.json();

        if (data.success) {
          // åŸ·è¡Œæ“ä½œ
          const resOp = await fetch('/operation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              op: pendingOperation,
              id: currentTarget.id,
              userId: currentTarget.userid
            })
          });
          const opData = await resOp.json();

          if (opData.success) {
            showToast(opData.message || 'æ“ä½œæˆåŠŸ');
            loadAccounts(); // åˆ·æ–°åˆ—è¡¨
          } else {
            showToast(opData.error || 'æ“ä½œå¤±æ•—');
          }
          document.getElementById('operations-modal').classList.add('hidden');
          document.getElementById('password-modal').classList.add('hidden');
        } else {
          error.textContent = data.message || 'å¯†ç¢¼éŒ¯èª¤';
          error.classList.remove('hidden');
        }
      } catch (err) {
        error.textContent = 'é€£ç·šå¤±æ•—';
        error.classList.remove('hidden');
      }
    });

    document.getElementById('password-cancel').addEventListener('click', () => {
      document.getElementById('password-modal').classList.add('hidden');
    });
  </script>
</body>
</html>
